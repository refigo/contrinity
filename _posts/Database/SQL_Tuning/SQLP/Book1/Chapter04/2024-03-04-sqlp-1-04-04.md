---
title: <오라클 성능 고도화 원리와 해법1> Ch04-04 커서 공유
date: 2024-03-04
categories: sql tuning
---


### 오라클 성능 고도화 원리와 해법1 - Ch04-04 커서 공유

#### (1) 커서란?

커서(Cursor)는 상황에 따라 여러 가지 의미로 사용되므로 커서 공유를 설명하기에 앞서 커서가 무엇인지 그 의미부터 명확히 할 필요가 있다. 결론부터 말하면, 우리가 흔히 말하는 커서는 아래 3가지를 모두 일컫는 말이다.

- 공유 커서(shared cursor): 라이브러리 캐시에 공유돼 있는 Shared SQL Area
- 세션 커서(session cursor): Private SQL Area에 저장된 커서
- 애플리케이션 커서(application cursor): 세션 커서를 가리키는 핸들

##### 공유 커서(shared cursor)

JAVA, VB, Pro\*C, PL/SQL 등에서 SQL을 수행하면 서버 프로세스는 해당 SQL이 라이브러리 캐시에 공유돼 있는지를 먼저 확인한다. 없으면, 최적화 과정을 통해 실행 계획을 만들고 라이브러리 캐시에 공유한다. 그렇게 라이브러리 캐시에 공유돼 있는 Shared SQL Area를 '커서'라고 부른다.

##### 세션 커서(session cursor)

라이브러리 캐시에 공유돼 있는 커서를 실행할 때 우선 PGA 영역에 메모리를 할당한다. 이를 'Private SQL Area'라고 하는데, Persistent Area`34)`와 Runtime Area`35)`로 나뉜다. Shared SQL Area를 읽어 커서를 실행하는데 필요한 정보들을 Private SQL Area에 담고, 공유 커서를 가리키는 포인터를 유지한다. 그리고 커서의 상태(open, bound, execute, close 등) 정보도 관리한다. 커서를 실행하기 위한 이런 준비과정을 "커서를 오픈한다"고 표현하고, PGA에 저장된 커서 정보(즉, 파싱된 SQL문과 문장을 수행하는데 필요한 기타 정보)를 또한 '커서'라고 부른다.

>	34) 바인드 변수 등을 저장함. 실행이 종료된 후 커서가 닫힐 때 해제됨
>	35) select문은 모든 레코드를 Fetch 완료하거나 실행을 취소할 때 해제되지만 insert, update, delete는 실행이 종료됨과 동시에 해제됨

오래 전에 C++과 JAVA 프로그래밍을 시작하면서 객체지향 프로그래밍(OOP, Object-Oriented Programming) 개념을 공부했던 기억이 난다. OOP에서 절대 빠질 수 없는 클래스(Class)와 객체(Object)를 논할 때, 대개 아래와 같이 설명한다.

- 클래스를 인스턴스화(Instantiate)한 것이 객체다.
- 클래스는 디자인이고, 그것을 실체화한 것이 객체다.
- 클래스는 붕어빵을 만드는 틀(template)이고, 객체는 그 틀로써 만들어낸 붕어빵이다.

**라이브러리 캐시에 공유돼 있는 커서는 SQL을 수행하는 데 필요한 루틴(routine)을 정의한 것이다. 즉, 클래스 상태다. 물론 그 루틴을 정의하고 클래스를 디자인한 것은 옵티마이저다.** 커서 오픈, 즉 라이브러리 캐시에 공유돼 있는 커서를 PGA로 인스턴스화하는 것을 JAVA 스타일로 표현하면 아래와 같다.

`Cursor c = new Cursor();`

자바 런타임이 이 부분을 만나면 메모리를 할당하고 클래스를 객체로 인스턴스화함으로써 실제 처리 루틴을 실행할 수 있는 상태로 만든다. **마찬가지로 오라클에서도 커서를 오픈하면 라이브러리 캐시에 공유돼있는 커서를 인스턴스화함으로써 PGA에 커서를 위한 메모리 공간(Persistent Area, Runtime Area)을 할당하고, 실제 데이터 추출을 시작할 수 있도록 준비 작업을 한다. 이제 '세션 커서'와 '커서 오픈'에 대한 개념이 명확해졌을 것이다.**

##### 애플리케이션커서(application cursor)

마지막으로 PGA에 있는 커서를 핸들링하려면 JAVA, VB, Pro\*C, PL/SQL 같은 클라이언트 애플리케이션에도 리소스를 할당해야 하는데, 이 또한 커서라는 용어를 사용한다.

그림 4-7은 지금까지 설명한 공유 커서, 세션 커서, 애플리케이션 커서 개념을 이해하기 쉽게 그림으로 표현한 것이다.

![](/assets/images/sqlp/sqlp1-04-04-1-img4-7.png)

